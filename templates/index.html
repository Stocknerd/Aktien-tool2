<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aktien‑Bild Generator</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    #suggestions{display:none;max-height:220px;overflow-y:auto;z-index:1050}
    #suggestions li:hover{background:#f0f0f0;cursor:pointer}
  </style>
</head>
<body class="bg-light">
  <div class="container py-5">
    <h1 class="text-center mb-4">Aktien‑Bild erstellen</h1>

    <form class="card shadow-sm p-4 mx-auto" style="max-width:640px" method="post" action="{{ url_for('generate_image') }}">
      <!-- Suche / Ticker -->
      <div class="mb-3 position-relative">
        <label for="stock-search" class="form-label">Aktie suchen</label>
        <input id="stock-search" type="text" class="form-control" placeholder="Apple, BASF…" autocomplete="off">
        <ul id="suggestions" class="list-group position-absolute top-100 start-0 w-100 shadow"></ul>
      </div>
      <div class="mb-3">
        <label for="ticker" class="form-label">Ticker (Pflichtfeld)</label>
        <input id="ticker" name="ticker" class="form-control" required>
      </div>

      <!-- Kennzahlen -->
      <label class="form-label d-flex justify-content-between align-items-center">
        Kennzahlen (max 8)
        <small id="metric-counter" class="text-muted">0 / 8</small>
      </label>

      <!-- Default‑Kennzahlen (immer sichtbar) -->
      <div class="row row-cols-2 g-2 mb-2">
        {% for m in available_metrics if m.key in default_metrics %}
        <div class="col form-check">
          <input class="form-check-input metric-chk" type="checkbox" name="metrics" value="{{ m.key }}" id="chk_{{ m.key|replace(' ','_') }}" checked>
          <label class="form-check-label" for="chk_{{ m.key|replace(' ','_') }}">{{ m.label }}</label>
        </div>
        {% endfor %}
      </div>

      <!-- Button zum Aufklappen -->
      <p>
        <a class="btn btn-outline-secondary btn-sm" data-bs-toggle="collapse" href="#moreMetrics" role="button" aria-expanded="false" aria-controls="moreMetrics">
          Weitere Kennzahlen anzeigen ▼
        </a>
      </p>

      <!-- Versteckte weiteren Kennzahlen -->
      <div class="collapse" id="moreMetrics">
        <div class="row row-cols-2 g-2 mb-3">
          {% for m in available_metrics if m.key not in default_metrics %}
          <div class="col form-check">
            <input class="form-check-input metric-chk" type="checkbox" name="metrics" value="{{ m.key }}" id="chk_{{ m.key|replace(' ','_') }}">
            <label class="form-check-label" for="chk_{{ m.key|replace(' ','_') }}">{{ m.label }}</label>
          </div>
          {% endfor %}
        </div>
      </div>

      <button class="btn btn-primary w-100">Bild erzeugen</button>
    </form>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ─── Autocomplete ────────────────────────────────────────────
    const search=document.getElementById('stock-search');
    const ticker=document.getElementById('ticker');
    const sugg=document.getElementById('suggestions');
    async function fetchMatches(q){if(!q)return[];const r=await fetch(`/search?q=${encodeURIComponent(q)}`);return r.ok?await r.json():[]}
    search.addEventListener('input',async e=>{const q=e.target.value.trim();if(!q){sugg.style.display='none';return}const d=await fetchMatches(q);if(!d.length){sugg.style.display='none';return}sugg.innerHTML=d.map(o=>`<li class='list-group-item' data-sym='${o.symbol}'>${o.symbol} – ${o.name}</li>`).join('');sugg.style.display='block';});
    sugg.addEventListener('click',e=>{const li=e.target.closest('li[data-sym]');if(!li)return;search.value=ticker.value=li.dataset.sym;sugg.style.display='none';});
    document.addEventListener('click',e=>{if(!search.contains(e.target)&&!sugg.contains(e.target))sugg.style.display='none';});

    // ─── Checkbox‑Limit ─────────────────────────────────────────
    const MAX=8;const chks=[...document.querySelectorAll('.metric-chk')];const counter=document.getElementById('metric-counter');
    function enforce(){const sel=chks.filter(c=>c.checked);counter.textContent=`${sel.length} / ${MAX}`;if(sel.length>=MAX){chks.forEach(c=>{if(!c.checked)c.disabled=true;});}else{chks.forEach(c=>c.disabled=false);} }
    chks.forEach(c=>c.addEventListener('change',enforce));
    enforce();
  </script>
</body>
</html>
