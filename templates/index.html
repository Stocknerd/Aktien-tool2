<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Stock Visualizer</title>

    <!-- Bootstrap 5 für Layout/Styles -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      /* Dropdown für Autocomplete */
      #suggestions {
        display: none;
        max-height: 240px;
        overflow-y: auto;
        z-index: 1050;
        cursor: pointer;
      }
      #suggestions li:hover {
        background: var(--bs-secondary-bg-subtle, #f8f9fa);
      }
    </style>
  </head>
  <body class="bg-light">
    <div class="container py-5">
      <h1 class="mb-4 text-center">Aktien‑Chart mit Standard‑Hintergrund</h1>

      <!-- Formular: Live‑Suche ODER manueller Ticker -->
      <form
        class="card shadow-sm p-4 mx-auto"
        style="max-width: 540px;"
        action="{{ url_for('generate_image') }}"
        method="post"
      >
        <!-- Live-Suche -->
        <div class="mb-3 position-relative">
          <label for="stock-search" class="form-label">Aktie suchen (optional)</label>
          <input
            type="text"
            id="stock-search"
            class="form-control"
            placeholder="Apple, Microsoft …"
            autocomplete="off"
          />
          <ul
            id="suggestions"
            class="list-group position-absolute top-100 start-0 w-100 shadow"
          ></ul>
        </div>

        <!-- Manueller Ticker (Pflicht) -->
        <div class="mb-3">
          <label for="ticker" class="form-label">Ticker&nbsp;<span class="text-muted">(Pflichtfeld)</span></label>
          <input
            type="text"
            id="ticker"
            name="ticker"
            class="form-control"
            placeholder="AAPL, MSFT, BASF …"
            required
          />
        </div>

        <button type="submit" class="btn btn-primary w-100">Chart erzeugen</button>
      </form>
    </div>

    <!-- Konfig‑Tag: Falls als Template gerendert, trägt Jinja hier den Pfad ein -->
    <script id="config" data-search-url="{{ url_for('search') }}"></script>

    <!-- Autocomplete & Form‑Handling -->
    <script>
      // ---- Konfiguration ----
      const SEARCH_URL =
        document.getElementById("config").dataset.searchUrl || "/search"; // Fallback für reine HTML-Auslieferung

      // ---- Utility: HTML‑Escape für Dropdown-Einträge ----
      const htmlEscape = (str) =>
        str.replace(/[&<>"']/g, (c) => ({
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#39;",
        }[c]));

      // ---- DOM-Knoten ----
      const searchInput = document.getElementById("stock-search");
      const tickerInput = document.getElementById("ticker");
      const suggestions = document.getElementById("suggestions");

      // ---- Helper: Fetch‑Abfrage an /search ----
      async function fetchMatches(query) {
        try {
          const res = await fetch(`${SEARCH_URL}?q=${encodeURIComponent(query)}`);
          if (!res.ok) {
            console.warn("/search Status", res.status);
            return [];
          }
          const data = await res.json();
          return Array.isArray(data) ? data : [];
        } catch (err) {
          console.error("/search Fehler", err);
          return [];
        }
      }

      // ---- Eingabe-Listener ----
      searchInput.addEventListener("input", async ({ target }) => {
        const q = target.value.trim();
        if (!q) return hideSuggestions();

        const data = await fetchMatches(q);
        if (!data.length) return hideSuggestions();

        suggestions.innerHTML = data
          .slice(0, 10)
          .map((item) => {
            // Backend kann Symbol/Name in verschiedenen Key‑Varianten schicken
            const symbol = item.symbol || item.Symbol || "";
            const name = item.name || item.Security || item.security || "";
            return `<li class="list-group-item" data-symbol="${symbol}">${htmlEscape(
              symbol
            )} – ${htmlEscape(name)}</li>`;
          })
          .join("");

        suggestions.style.display = "block";
      });

      // ---- Klick auf Vorschlag ----
      suggestions.addEventListener("click", (e) => {
        const li = e.target.closest("li[data-symbol]");
        if (!li) return;
        const { symbol } = li.dataset;
        searchInput.value = symbol;
        tickerInput.value = symbol;
        hideSuggestions();
        tickerInput.focus();
      });

      // ---- Klick außerhalb → Dropdown schließen ----
      document.addEventListener("click", (e) => {
        if (!searchInput.contains(e.target) && !suggestions.contains(e.target)) {
          hideSuggestions();
        }
      });

      // ---- Utils ----
      function hideSuggestions() {
        suggestions.style.display = "none";
        suggestions.innerHTML = "";
      }
    </script>
  </body>
</html>
